{% extends "base.html" %} {% block title %}{{ book.title }} - Kindle
Highlights{% endblock %} {% block extra_css %}
<style>
    .hidden-highlight {
        opacity: 0.5;
        background: #f0f0f0 !important;
    }
    .toggle-visibility-btn {
        background: #fff;
        color: #666;
        border: 1px solid #e0e0e0;
        padding: 4px 12px;
        border-radius: 4px;
        font-size: 11px;
        cursor: pointer;
        transition: all 0.2s;
        font-family: inherit;
    }
    .toggle-visibility-btn:hover {
        background: #f5f5f5;
        border-color: #999;
    }
    .edit-book-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        margin-top: 15px;
        margin-bottom: 20px;
        display: block;
    }
    .edit-book-btn:hover {
        background: #0056b3;
    }
    .star-rating-section {
        margin-top: 20px;
        padding: 15px;
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 5px;
    }
    .star-rating-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    .star-rating-header h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
    }
    .rating-input-container {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .star-display {
        display: flex;
        gap: 4px;
    }
    .star-display .star {
        font-size: 28px;
        color: #ddd;
        transition: color 0.2s;
        user-select: none;
    }
    .star-display .star.filled {
        color: #ffc107;
    }
    .star-display .star.partial {
        background: linear-gradient(
            90deg,
            #ffc107 var(--fill-percent),
            #ddd var(--fill-percent)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    .rating-input {
        width: 70px;
        padding: 8px 12px;
        font-size: 16px;
        border: 2px solid #ddd;
        border-radius: 6px;
        text-align: center;
        transition: border-color 0.2s;
        font-family: inherit;
    }
    .rating-input:focus {
        outline: none;
        border-color: #007bff;
    }
    .rating-input::-webkit-inner-spin-button,
    .rating-input::-webkit-outer-spin-button {
        opacity: 1;
    }
    .rating-label {
        font-size: 16px;
        color: #666;
        font-weight: 500;
    }
    .clear-rating {
        background: #f0f0f0;
        border: none;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        cursor: pointer;
        font-size: 16px;
        color: #666;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        padding: 0;
    }
    .clear-rating:hover {
        background: #e0e0e0;
        color: #333;
    }
    .review-section {
        margin-top: 20px;
        padding: 15px;
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 5px;
    }
    .review-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    .review-header h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
    }
    .save-status {
        font-size: 12px;
        color: #28a745;
        opacity: 0;
        transition: opacity 0.3s;
    }
    .save-status.show {
        opacity: 1;
    }
    .review-textarea {
        width: 100%;
        min-height: 150px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        font-family: inherit;
        resize: vertical;
        box-sizing: border-box;
    }
    .review-textarea:focus {
        outline: none;
        border-color: #007bff;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }
    .modal-content {
        background-color: #fff;
        margin: 5% auto;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e0e0e0;
    }
    .modal-header h2 {
        margin: 0;
        font-size: 20px;
    }
    .close {
        font-size: 28px;
        font-weight: bold;
        color: #999;
        cursor: pointer;
        background: none;
        border: none;
        padding: 0;
        width: 30px;
        height: 30px;
        line-height: 28px;
    }
    .close:hover {
        color: #333;
    }
    .form-group {
        margin-bottom: 15px;
    }
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        font-size: 14px;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        font-family: inherit;
        box-sizing: border-box;
    }
    .form-group textarea {
        resize: vertical;
        min-height: 80px;
    }
    .form-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #e0e0e0;
    }
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .btn-primary {
        background: #007bff;
        color: white;
    }
    .btn-primary:hover {
        background: #0056b3;
    }
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    .btn-secondary:hover {
        background: #545b62;
    }
    .book-header {
        display: flex;
        gap: 30px;
        align-items: flex-start;
        margin-bottom: 30px;
    }
    .book-detail-cover {
        width: 200px;
        height: auto;
        max-height: 300px;
        object-fit: contain;
        border-radius: 8px;
        flex-shrink: 0;
        background: #f9f9f9;
        padding: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .book-header-content {
        flex: 1;
        min-width: 0;
    }
    .book-header-content h2 {
        margin-top: 0;
        margin-bottom: 10px;
        font-size: 28px;
        line-height: 1.3;
    }
    .book-header-content .author {
        font-size: 18px;
        color: #666;
        margin-bottom: 12px;
    }
    .book-header-content .meta {
        font-size: 14px;
        color: #999;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
    }
    .book-details {
        margin-top: 15px;
        margin-bottom: 20px;
        padding: 15px;
        background: #f9f9f9;
        border: 1px solid #e0e0e0;
        border-radius: 5px;
        font-size: 14px;
        box-shadow: none;
    }
    .book-details > div {
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    .book-details > div:last-child {
        border-bottom: none;
    }
    .book-details strong {
        color: #666;
        font-weight: 600;
        margin-right: 8px;
    }
    .star-rating-section {
        margin-bottom: 20px;
    }
    .review-section {
        margin-bottom: 20px;
    }
    @media (max-width: 768px) {
        .book-header {
            flex-direction: column;
        }
        .book-detail-cover {
            width: 100%;
            max-width: 200px;
            align-self: center;
        }
    }
</style>
{% endblock %} {% block content %}
<a href="{{ url_for('index') }}" class="back-link">← Back to all books</a>

<div class="book-header">
    {% if book.image_url %}
    <img
        src="{{ get_local_image_url(book.image_url) }}"
        alt="{{ book.title }}"
        class="book-detail-cover"
        onerror="this.style.display = 'none'"
    />
    {% endif %}
    <div class="book-header-content">
        <h2>{{ book.title }}</h2>
        <div class="author">by {{ book.author }}</div>
        <div class="meta">
            <span>ASIN: {{ book.asin }}</span>
            <span>{{ highlights|length }} highlights</span>
            {% if book.last_annotated_date %}<span
                >Last annotated: {{ format_date(book.last_annotated_date)
                }}</span
            >{% endif %}
        </div>
    </div>
</div>

{% if book.status or book.format or book.isbn or book.genres or book.notes %}
<div class="book-details">
    {% if book.status %}
    <div><strong>Status:</strong> {{ book.status }}</div>
    {% endif %} {% if book.format %}
    <div><strong>Format:</strong> {{ book.format }}</div>
    {% endif %} {% if book.isbn %}
    <div><strong>ISBN:</strong> {{ book.isbn }}</div>
    {% endif %} {% if book.purchase_date %}
    <div><strong>Purchased:</strong> {{ format_date(book.purchase_date) }}</div>
    {% endif %} {% if book.start_date %}
    <div><strong>Started:</strong> {{ format_date(book.start_date) }}</div>
    {% endif %} {% if book.end_date %}
    <div><strong>Finished:</strong> {{ format_date(book.end_date) }}</div>
    {% endif %} {% if book.reading_time %}
    <div><strong>Reading Time:</strong> {{ book.reading_time }}</div>
    {% endif %} {% if book.genres %}
    <div><strong>Genres:</strong> {{ book.genres }}</div>
    {% endif %} {% if book.classification %}
    <div><strong>Classification:</strong> {{ book.classification }}</div>
    {% endif %} {% if book.price_gbp %}
    <div>
        <strong>Price (GBP):</strong> £{{ "%.2f"|format(book.price_gbp) }}
    </div>
    {% endif %} {% if book.price_inr %}
    <div>
        <strong>Price (INR):</strong> ₹{{ "%.2f"|format(book.price_inr) }}
    </div>
    {% endif %} {% if book.shop_link %}
    <div>
        <strong>Shop:</strong>
        <a href="{{ book.shop_link }}" target="_blank">View</a>
    </div>
    {% endif %} {% if book.goodreads_link %}
    <div>
        <strong>Goodreads:</strong>
        <a href="{{ book.goodreads_link }}" target="_blank">View</a>
    </div>
    {% endif %} {% if book.notes %}
    <div style="margin-top: 10px"><strong>Notes:</strong> {{ book.notes }}</div>
    {% endif %}
</div>

<button class="edit-book-btn" onclick="openEditModal()">
    Edit Book Details
</button>
{% endif %}

<div class="star-rating-section">
    <div class="star-rating-header">
        <h3>My Rating</h3>
        <span class="save-status" id="ratingSaveStatus">✓ Saved</span>
    </div>
    <div class="rating-input-container">
        <div class="star-display" id="starDisplay">
            <span class="star">★</span>
            <span class="star">★</span>
            <span class="star">★</span>
            <span class="star">★</span>
            <span class="star">★</span>
        </div>
        <input
            type="number"
            id="ratingInput"
            class="rating-input"
            min="0"
            step="0.1"
            value="{{ book.star_rating if book.star_rating else '' }}"
            placeholder="0.0"
        />
        <span class="rating-label">/ 5</span>
        {% if book.star_rating %}
        <button class="clear-rating" id="clearRating" title="Clear rating">
            ✕
        </button>
        {% endif %}
    </div>
</div>

<div class="review-section">
    <div class="review-header">
        <h3>My Review</h3>
        <span class="save-status" id="saveStatus">✓ Saved</span>
    </div>
    <textarea
        class="review-textarea"
        id="reviewTextarea"
        placeholder="Write your review of this book..."
    >
{{ book.review or '' }}</textarea
    >
</div>

<div id="editBookModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Edit Book Details</h2>
            <button class="close" onclick="closeEditModal()">&times;</button>
        </div>
        <form id="editBookForm">
            <div class="form-group">
                <label for="title">Title</label>
                <input
                    type="text"
                    id="title"
                    name="title"
                    value="{{ book.title or '' }}"
                    placeholder="Book title"
                />
            </div>
            <div class="form-group">
                <label for="author">Author</label>
                <input
                    type="text"
                    id="author"
                    name="author"
                    value="{{ book.author or '' }}"
                    placeholder="Author name"
                />
            </div>
            <div class="form-group">
                <label for="status">Status</label>
                <select id="status" name="status">
                    <option value="">Select status...</option>
                    <option value="Not Started">Not Started</option>
                    <option value="Started">Started</option>
                    <option value="Done">Done</option>
                    <option value="Abandoned">Abandoned</option>
                </select>
            </div>
            <div class="form-group">
                <label for="format">Format</label>
                <select id="format" name="format">
                    <option value="">Select format...</option>
                    <option value="eBook">eBook</option>
                    <option value="Paperback">Paperback</option>
                    <option value="Hardcover">Hardcover</option>
                    <option value="Audiobook">Audiobook</option>
                </select>
            </div>
            <div class="form-group">
                <label for="isbn">ISBN</label>
                <input
                    type="text"
                    id="isbn"
                    name="isbn"
                    value="{{ book.isbn or '' }}"
                    placeholder="ISBN"
                />
            </div>
            <div class="form-group">
                <label for="purchase_date">Purchase Date</label>
                <input
                    type="date"
                    id="purchase_date"
                    name="purchase_date"
                    value="{% if book.purchase_date %}{{ book.purchase_date.strftime('%Y-%m-%d') if book.purchase_date.strftime else book.purchase_date[:10] }}{% endif %}"
                />
            </div>
            <div class="form-group">
                <label for="start_date">Start Date</label>
                <input
                    type="date"
                    id="start_date"
                    name="start_date"
                    value="{% if book.start_date %}{{ book.start_date.strftime('%Y-%m-%d') if book.start_date.strftime else book.start_date[:10] }}{% endif %}"
                />
            </div>
            <div class="form-group">
                <label for="end_date">End Date</label>
                <input
                    type="date"
                    id="end_date"
                    name="end_date"
                    value="{% if book.end_date %}{{ book.end_date.strftime('%Y-%m-%d') if book.end_date.strftime else book.end_date[:10] }}{% endif %}"
                />
            </div>
            <div class="form-group">
                <label for="reading_time">Reading Time (HH:MM)</label>
                <input
                    type="text"
                    id="reading_time"
                    name="reading_time"
                    value="{{ book.reading_time or '' }}"
                    placeholder="e.g., 05:30"
                />
            </div>
            <div class="form-group">
                <label for="genres">Genres (comma-separated)</label>
                <input
                    type="text"
                    id="genres"
                    name="genres"
                    value="{{ book.genres or '' }}"
                    placeholder="e.g., Fiction, Science Fiction"
                />
            </div>
            <div class="form-group">
                <label for="classification"
                    >Classification (Dewey Decimal)</label
                >
                <input
                    type="text"
                    id="classification"
                    name="classification"
                    value="{{ book.classification or '' }}"
                    placeholder="e.g., 813.54"
                />
            </div>
            <div class="form-group">
                <label for="shop_link">Shop Link</label>
                <input
                    type="url"
                    id="shop_link"
                    name="shop_link"
                    value="{{ book.shop_link or '' }}"
                    placeholder="https://..."
                />
            </div>
            <div class="form-group">
                <label for="goodreads_link">Goodreads Link</label>
                <input
                    type="url"
                    id="goodreads_link"
                    name="goodreads_link"
                    value="{{ book.goodreads_link or '' }}"
                    placeholder="https://goodreads.com/..."
                />
            </div>
            <div class="form-group">
                <label for="price_gbp">Price (GBP)</label>
                <input
                    type="text"
                    id="price_gbp"
                    name="price_gbp"
                    value="{% if book.price_gbp %}{{ '%.2f'|format(book.price_gbp) }}{% endif %}"
                    placeholder="9.99"
                />
            </div>
            <div class="form-group">
                <label for="price_inr">Price (INR)</label>
                <input
                    type="text"
                    id="price_inr"
                    name="price_inr"
                    value="{% if book.price_inr %}{{ '%.2f'|format(book.price_inr) }}{% endif %}"
                    placeholder="299"
                />
            </div>
            <div class="form-group">
                <label for="notes">Notes</label>
                <textarea
                    id="notes"
                    name="notes"
                    placeholder="Your notes about this book..."
                >
{{ book.notes or '' }}</textarea
                >
            </div>
            <div class="form-actions">
                <button
                    type="button"
                    class="btn btn-secondary"
                    onclick="closeEditModal()"
                >
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

{% if highlights %} {% for highlight in highlights %}
<div
    class="highlight {{ color_class(highlight.color) }} {% if highlight.is_hidden %}hidden-highlight{% endif %}"
    id="highlight-{{ highlight.id }}"
>
    <div class="highlight-text">{{ highlight.text }}</div>
    {% if highlight.note %}
    <div class="highlight-note">Note: {{ highlight.note }}</div>
    {% endif %}
    <div class="highlight-meta">
        <span
            >{% if highlight.page %}Page {{ highlight.page }}{% endif %}{% if
            highlight.location %} · Location {{ highlight.location }}{% endif
            %}</span
        >
        <span
            >{% if highlight.created_date %}{{
            format_date(highlight.created_date) }}{% endif %}</span
        >
        <button
            class="toggle-visibility-btn"
            onclick="toggleHighlightVisibility('{{ highlight.id }}', {{ 'true' if highlight.is_hidden else 'false' }})"
        >
            {% if highlight.is_hidden %}Show{% else %}Hide{% endif %}
        </button>
    </div>
</div>
{% endfor %} {% else %}
<div class="empty-state">
    <h2>No highlights found</h2>
    <p>Run <code>kindle-sync sync</code> to sync highlights for this book</p>
</div>
{% endif %}

<script>
    async function toggleHighlightVisibility(highlightId, currentlyHidden) {
        try {
            const response = await fetch(
                `/api/highlights/${highlightId}/toggle-visibility`,
                {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                },
            );
            const data = await response.json();
            if (data.success) {
                const highlightDiv = document.getElementById(
                    `highlight-${highlightId}`,
                );
                const button = highlightDiv.querySelector(
                    ".toggle-visibility-btn",
                );
                if (data.data.is_hidden) {
                    highlightDiv.classList.add("hidden-highlight");
                    button.textContent = "Show";
                } else {
                    highlightDiv.classList.remove("hidden-highlight");
                    button.textContent = "Hide";
                }
            } else {
                alert(
                    "Failed to toggle highlight visibility: " +
                        (data.message || data.error),
                );
            }
        } catch (error) {
            alert("Failed to toggle highlight visibility: " + error.message);
        }
    }

    function openEditModal() {
        document.getElementById("editBookModal").style.display = "block";
        const bookData = {
            status: "{{ book.status or '' }}",
            format: "{{ book.format or '' }}",
        };
        if (bookData.status)
            document.getElementById("status").value = bookData.status;
        if (bookData.format)
            document.getElementById("format").value = bookData.format;
    }

    function closeEditModal() {
        document.getElementById("editBookModal").style.display = "none";
    }
    window.onclick = function (event) {
        const modal = document.getElementById("editBookModal");
        if (event.target === modal) {
            closeEditModal();
        }
    };

    document
        .getElementById("editBookForm")
        .addEventListener("submit", async function (e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {};
            for (let [key, value] of formData.entries()) {
                if (value && value.trim() !== "") {
                    // Parse price fields as floats
                    if (key === "price_gbp" || key === "price_inr") {
                        // Remove currency symbols and commas
                        const cleaned = value.replace(/[£₹,\s]/g, "");
                        data[key] = parseFloat(cleaned) || null;
                    } else if (key === "star_rating") {
                        data[key] = parseFloat(value.trim()) || null;
                    } else {
                        data[key] = value.trim();
                    }
                } else {
                    data[key] = null;
                }
            }
            try {
                const response = await fetch(
                    "/api/books/{{ book.asin }}/metadata",
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data),
                    },
                );
                const result = await response.json();
                if (result.success) {
                    alert("Book details updated successfully!");
                    window.location.reload();
                } else {
                    alert(
                        "Failed to update book details: " +
                            (result.message || result.error),
                    );
                }
            } catch (error) {
                alert("Failed to update book details: " + error.message);
            }
        });

    let reviewSaveTimeout;
    const reviewTextarea = document.getElementById("reviewTextarea");
    const saveStatus = document.getElementById("saveStatus");

    reviewTextarea.addEventListener("input", function () {
        clearTimeout(reviewSaveTimeout);
        reviewSaveTimeout = setTimeout(async () => {
            const review = reviewTextarea.value.trim();
            try {
                const response = await fetch(
                    "/api/books/{{ book.asin }}/metadata",
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ review: review || null }),
                    },
                );
                const result = await response.json();
                if (result.success) {
                    saveStatus.classList.add("show");
                    setTimeout(() => saveStatus.classList.remove("show"), 2000);
                }
            } catch (error) {
                console.error("Failed to auto-save review:", error);
            }
        }, 3000);
    });

    // Star rating functionality
    const ratingInput = document.getElementById("ratingInput");
    const starDisplay = document.getElementById("starDisplay");
    const stars = starDisplay.querySelectorAll(".star");
    const ratingSaveStatus = document.getElementById("ratingSaveStatus");
    const clearRatingBtn = document.getElementById("clearRating");

    function updateStars(rating) {
        stars.forEach((star, index) => {
            star.classList.remove("filled", "partial");
            star.style.removeProperty("--fill-percent");

            if (rating >= index + 1) {
                // Full star
                star.classList.add("filled");
            } else if (rating > index) {
                // Partial star
                const fillPercent = ((rating - index) * 100).toFixed(1);
                star.classList.add("partial");
                star.style.setProperty("--fill-percent", `${fillPercent}%`);
            }
        });
    }

    async function saveRating(rating) {
        if (rating === null || rating === "") {
            rating = null;
        } else {
            rating = parseFloat(rating);
            if (isNaN(rating) || rating < 0) {
                return;
            }
            rating = Math.round(rating * 10) / 10; // Round to 1 decimal
        }

        try {
            const response = await fetch(
                "/api/books/{{ book.asin }}/metadata",
                {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ star_rating: rating }),
                },
            );
            const result = await response.json();
            if (result.success) {
                ratingSaveStatus.classList.add("show");
                setTimeout(
                    () => ratingSaveStatus.classList.remove("show"),
                    2000,
                );

                // Update clear button visibility
                if (rating !== null && !clearRatingBtn) {
                    location.reload();
                } else if (rating === null && clearRatingBtn) {
                    location.reload();
                }
            }
        } catch (error) {
            console.error("Failed to save rating:", error);
        }
    }

    // Initialize stars
    if (ratingInput.value) {
        updateStars(parseFloat(ratingInput.value));
    }

    // Update stars and auto-save when input changes
    let ratingSaveTimeout;
    ratingInput.addEventListener("input", function () {
        const rating = this.value ? parseFloat(this.value) : 0;
        updateStars(rating);

        // Auto-save with debounce
        clearTimeout(ratingSaveTimeout);
        ratingSaveTimeout = setTimeout(() => {
            saveRating(this.value);
        }, 1500);
    });

    ratingInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
            this.blur();
        }
    });

    // Clear rating button
    if (clearRatingBtn) {
        clearRatingBtn.addEventListener("click", async function () {
            ratingInput.value = "";
            updateStars(0);
            await saveRating(null);
        });
    }
</script>
{% endblock %}
