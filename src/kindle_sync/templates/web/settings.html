{% extends "base.html" %} {% block title %}Settings - Kindle Highlights{%
endblock %} {% block content %}
<div class="settings-container">
    <h2>Settings</h2>

    <!-- Account & Status Section -->
    <div class="settings-section">
        <div id="account-status-panel">
            <div class="loading">Loading...</div>
        </div>
        <div id="account-result"></div>
    </div>

    <!-- Sync Section -->
    <div class="settings-section">
        <h3>üîÑ Sync Highlights</h3>
        <p class="section-description">
            Sync your Kindle highlights from Amazon. This will download new
            highlights and update existing ones.
        </p>
        <div class="action-buttons">
            <button
                id="sync-btn"
                class="btn btn-primary"
                onclick="syncHighlights()"
            >
                Sync Now
            </button>
            <button
                id="full-sync-btn"
                class="btn btn-secondary"
                onclick="syncHighlights(true)"
            >
                Full Sync (Slower)
            </button>
        </div>
        <div id="sync-result"></div>
    </div>

    <!-- Sync Images Section -->
    <div class="settings-section">
        <h3>üñºÔ∏è Sync Images</h3>
        <p class="section-description">
            Download book cover images. Configure the directory where images
            will be saved and select the image quality.
        </p>
        <div class="export-dir-form">
            <div class="form-group">
                <label for="images-directory">Images Directory:</label>
                <input
                    type="text"
                    id="images-directory"
                    class="form-control"
                    placeholder="Loading..."
                />
            </div>
            <button
                id="save-images-dir-btn"
                class="btn btn-primary"
                onclick="saveImagesDirectory()"
            >
                Save Directory
            </button>
        </div>
        <div id="images-dir-result"></div>
        <div class="export-form" style="margin-top: 16px">
            <div class="form-group">
                <label for="image-size">Image Size:</label>
                <select id="image-size" class="form-control">
                    <option value="SMALL">Small</option>
                    <option value="MEDIUM">Medium</option>
                    <option value="LARGE">Large</option>
                    <option value="ORIGINAL" selected>Original</option>
                </select>
            </div>
            <button
                id="sync-images-btn"
                class="btn btn-primary"
                onclick="syncImages()"
            >
                Sync Images
            </button>
        </div>
        <div id="sync-images-result"></div>
    </div>

    <!-- Export Section -->
    <div class="settings-section">
        <h3>üì§ Export Highlights</h3>
        <p class="section-description">
            Export your highlights to various formats. Configure the directory
            where files will be saved and select your preferred format.
        </p>
        <div class="export-dir-form">
            <div class="form-group">
                <label for="export-directory">Export Directory:</label>
                <input
                    type="text"
                    id="export-directory"
                    class="form-control"
                    placeholder="Loading..."
                />
            </div>
            <button
                id="save-dir-btn"
                class="btn btn-primary"
                onclick="saveExportDirectory()"
            >
                Save Directory
            </button>
        </div>
        <div id="export-dir-result"></div>
        <div class="export-form" style="margin-top: 16px">
            <div class="form-group">
                <label for="export-format">Format:</label>
                <select id="export-format" class="form-control">
                    <option value="MARKDOWN">Markdown (.md)</option>
                    <option value="JSON">JSON (.json)</option>
                    <option value="CSV">CSV (.csv)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="export-template">Template:</label>
                <select id="export-template" class="form-control">
                    <option value="simple">Simple</option>
                    <option value="astro" selected>Astro</option>
                </select>
            </div>
            <button
                id="export-btn"
                class="btn btn-primary"
                onclick="exportHighlights()"
            >
                Export All Books
            </button>
        </div>
        <div id="export-result"></div>
    </div>
</div>

<style>
    .settings-container {
        max-width: 800px;
    }

    .settings-container h2 {
        font-size: 32px;
        margin-bottom: 30px;
        color: #232f3e;
    }

    .settings-section {
        background: #fff;
        border-radius: 8px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .settings-section h3 {
        font-size: 20px;
        margin-bottom: 12px;
        color: #232f3e;
    }

    .section-description {
        color: #666;
        font-size: 14px;
        margin-bottom: 20px;
        line-height: 1.6;
    }

    .status-box {
        background: #f9f9f9;
        border-radius: 6px;
        padding: 16px;
        border: 1px solid #e0e0e0;
    }

    .status-box .loading {
        color: #999;
        font-style: italic;
    }

    .status-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #e0e0e0;
    }

    .status-item:last-child {
        border-bottom: none;
    }

    .status-label {
        font-weight: 600;
        color: #555;
    }

    .status-value {
        color: #333;
    }

    .status-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .status-badge.authenticated {
        background: #d4edda;
        color: #155724;
    }

    .status-badge.not-authenticated {
        background: #f8d7da;
        color: #721c24;
    }

    .action-buttons {
        display: flex;
        gap: 12px;
        margin-bottom: 16px;
    }

    .export-dir-form {
        display: flex;
        align-items: flex-end;
        gap: 16px;
        margin-bottom: 16px;
    }

    .export-form {
        display: flex;
        align-items: flex-end;
        gap: 16px;
        margin-bottom: 16px;
    }

    .form-group {
        flex: 1;
    }

    .form-group label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 6px;
        color: #555;
    }

    .form-control {
        width: 100%;
        padding: 10px 12px;
        font-size: 14px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-family: inherit;
        background: white;
    }

    .form-control:focus {
        outline: none;
        border-color: #0066c0;
    }

    .sync-details {
        background: #f9f9f9;
        border-radius: 6px;
        padding: 12px;
        margin-top: 12px;
        font-size: 13px;
    }

    .sync-details strong {
        color: #0066c0;
    }

    .sync-book {
        padding: 8px 0;
        border-bottom: 1px solid #e0e0e0;
    }

    .sync-book:last-child {
        border-bottom: none;
    }

    .sync-book-title {
        font-weight: 600;
        color: #333;
    }

    .sync-book-stats {
        color: #666;
        font-size: 12px;
        margin-top: 4px;
    }
</style>

<script>
    // Load status and export directory on page load
    document.addEventListener("DOMContentLoaded", () => {
        loadAccountStatusPanel();
        loadExportDirectory();
        loadImagesDirectory();
    });

    async function loadExportDirectory() {
        try {
            const response = await fetch("/api/export-directory");
            const data = await response.json();

            if (data.success) {
                document.getElementById("export-directory").value =
                    data.data.export_directory;
            }
        } catch (error) {
            document.getElementById("export-dir-result").innerHTML = `
                <div class="alert alert-error">Failed to load export directory: ${error.message}</div>
            `;
        }
    }

    async function loadImagesDirectory() {
        try {
            const response = await fetch("/api/images-directory");
            const data = await response.json();

            if (data.success) {
                document.getElementById("images-directory").value =
                    data.data.images_directory;
            }
        } catch (error) {
            document.getElementById("images-dir-result").innerHTML = `
                <div class="alert alert-error">Failed to load images directory: ${error.message}</div>
            `;
        }
    }

    async function saveExportDirectory() {
        const saveDirBtn = document.getElementById("save-dir-btn");
        const exportDirInput = document.getElementById("export-directory");
        const resultDiv = document.getElementById("export-dir-result");

        const exportDir = exportDirInput.value.trim();

        if (!exportDir) {
            resultDiv.innerHTML = `
                <div class="alert alert-error">Please enter a valid export directory</div>
            `;
            return;
        }

        saveDirBtn.disabled = true;
        resultDiv.innerHTML = '<div class="alert alert-info">Saving...</div>';

        try {
            const response = await fetch("/api/export-directory", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ export_directory: exportDir }),
            });

            const data = await response.json();

            if (data.success) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">${data.message}</div>
                `;
                // Clear the message after 3 seconds
                setTimeout(() => {
                    resultDiv.innerHTML = "";
                }, 3000);
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-error">${data.message || data.error}</div>
                `;
            }
        } catch (error) {
            resultDiv.innerHTML = `
                <div class="alert alert-error">Failed to save: ${error.message}</div>
            `;
        } finally {
            saveDirBtn.disabled = false;
        }
    }

    async function saveImagesDirectory() {
        const saveImagesDirBtn = document.getElementById("save-images-dir-btn");
        const imagesDirInput = document.getElementById("images-directory");
        const resultDiv = document.getElementById("images-dir-result");

        const imagesDir = imagesDirInput.value.trim();

        if (!imagesDir) {
            resultDiv.innerHTML = `
                <div class="alert alert-error">Please enter a valid images directory</div>
            `;
            return;
        }

        saveImagesDirBtn.disabled = true;
        resultDiv.innerHTML = '<div class="alert alert-info">Saving...</div>';

        try {
            const response = await fetch("/api/images-directory", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ images_directory: imagesDir }),
            });

            const data = await response.json();

            if (data.success) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">${data.message}</div>
                `;
                // Clear the message after 3 seconds
                setTimeout(() => {
                    resultDiv.innerHTML = "";
                }, 3000);
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-error">${data.message || data.error}</div>
                `;
            }
        } catch (error) {
            resultDiv.innerHTML = `
                <div class="alert alert-error">Failed to save: ${error.message}</div>
            `;
        } finally {
            saveImagesDirBtn.disabled = false;
        }
    }

    async function loadAccountStatusPanel() {
        try {
            const response = await fetch("/api/status");
            const data = await response.json();

            const panelDiv = document.getElementById("account-status-panel");

            if (data.authenticated) {
                // Show status panel when authenticated
                const statusHtml = `
                    <h3>üìä Status</h3>
                    <div class="status-box">
                        <div class="status-item">
                            <span class="status-label">Authentication Status:</span>
                            <span class="status-badge authenticated">‚úì Authenticated</span>
                        </div>
                        ${
                            data.session_age
                                ? `
                        <div class="status-item">
                            <span class="status-label">Session Age:</span>
                            <span class="status-value">${data.session_age}</span>
                        </div>
                        `
                                : ""
                        }
                        ${
                            data.last_sync
                                ? `
                        <div class="status-item">
                            <span class="status-label">Last Sync:</span>
                            <span class="status-value">${new Date(data.last_sync).toLocaleString()}</span>
                        </div>
                        `
                                : ""
                        }
                        <div class="status-item">
                            <span class="status-label">Total Books:</span>
                            <span class="status-value">${data.total_books}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Total Highlights:</span>
                            <span class="status-value">${data.total_highlights}</span>
                        </div>
                    </div>
                    <div style="margin-top: 16px;">
                        <button class="btn btn-danger" onclick="logout()">
                            Logout
                        </button>
                    </div>
                `;
                panelDiv.innerHTML = statusHtml;
            } else {
                // Show login panel when not authenticated
                const loginHtml = `
                    <h3>üë§ Account</h3>
                    <p class="section-description">
                        Connect to your Amazon account to sync your Kindle highlights.
                        A browser window will open for you to log in securely.
                    </p>
                    <div class="export-form">
                        <div class="form-group">
                            <label for="login-region">Amazon Region:</label>
                            <select id="login-region" class="form-control">
                                <option value="global">Global (amazon.com)</option>
                                <option value="uk">United Kingdom</option>
                                <option value="germany">Germany</option>
                                <option value="japan">Japan</option>
                                <option value="india">India</option>
                                <option value="spain">Spain</option>
                                <option value="italy">Italy</option>
                                <option value="france">France</option>
                            </select>
                        </div>
                        <button id="login-btn" class="btn btn-primary" onclick="login()">
                            Login to Amazon
                        </button>
                    </div>
                `;
                panelDiv.innerHTML = loginHtml;
            }
        } catch (error) {
            document.getElementById("account-status-panel").innerHTML = `
                <h3>‚ùå Error</h3>
                <div class="alert alert-error">Failed to load account status: ${error.message}</div>
            `;
        }
    }

    async function syncHighlights(full = false) {
        const syncBtn = document.getElementById("sync-btn");
        const fullSyncBtn = document.getElementById("full-sync-btn");
        const resultDiv = document.getElementById("sync-result");

        // Disable buttons
        syncBtn.disabled = true;
        fullSyncBtn.disabled = true;

        resultDiv.innerHTML =
            '<div class="alert alert-info">Syncing... This may take a minute.</div>';

        try {
            const response = await fetch("/api/sync", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ full: full }),
            });

            const data = await response.json();

            if (data.success) {
                let detailsHtml = "";
                if (data.data.books && data.data.books.length > 0) {
                    detailsHtml = '<div class="sync-details">';
                    data.data.books.forEach((book) => {
                        detailsHtml += `
                            <div class="sync-book">
                                <div class="sync-book-title">${book.title}</div>
                                <div class="sync-book-stats">
                                    ${book.new_highlights} new ¬∑ ${book.deleted_highlights} deleted ¬∑ ${book.total_highlights} total
                                </div>
                            </div>
                        `;
                    });
                    detailsHtml += "</div>";
                }

                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        ${data.message}
                        <br><strong>${data.data.books_synced}</strong> books synced
                        ¬∑ <strong>${data.data.new_highlights}</strong> new highlights
                        ${data.data.deleted_highlights > 0 ? `¬∑ <strong>${data.data.deleted_highlights}</strong> deleted` : ""}
                    </div>
                    ${detailsHtml}
                `;

                // Reload status
                loadAccountStatusPanel();
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-error">${data.message || data.error}</div>
                `;
            }
        } catch (error) {
            resultDiv.innerHTML = `
                <div class="alert alert-error">Sync failed: ${error.message}</div>
            `;
        } finally {
            syncBtn.disabled = false;
            fullSyncBtn.disabled = false;
        }
    }

    async function exportHighlights() {
        const exportBtn = document.getElementById("export-btn");
        const formatSelect = document.getElementById("export-format");
        const templateSelect = document.getElementById("export-template");
        const resultDiv = document.getElementById("export-result");

        const format = formatSelect.value;
        const template = templateSelect.value;

        // Get the configured export directory
        let exportDir;
        try {
            const dirResponse = await fetch("/api/export-directory");
            const dirData = await dirResponse.json();
            if (dirData.success) {
                exportDir = dirData.data.export_directory;
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-error">Failed to get export directory</div>
                `;
                return;
            }
        } catch (error) {
            resultDiv.innerHTML = `
                <div class="alert alert-error">Failed to get export directory: ${error.message}</div>
            `;
            return;
        }

        exportBtn.disabled = true;
        resultDiv.innerHTML =
            '<div class="alert alert-info">Exporting...</div>';

        try {
            const response = await fetch("/api/export", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    output_dir: exportDir,
                    format: format,
                    template: template,
                }),
            });

            const data = await response.json();

            if (data.success) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        ${data.message}
                        <br><strong>${data.data.files_created.length}</strong> files created in ${exportDir}
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-error">${data.message || data.error}</div>
                `;
            }
        } catch (error) {
            resultDiv.innerHTML = `
                <div class="alert alert-error">Export failed: ${error.message}</div>
            `;
        } finally {
            exportBtn.disabled = false;
        }
    }

    async function syncImages() {
        const syncImagesBtn = document.getElementById("sync-images-btn");
        const imageSizeSelect = document.getElementById("image-size");
        const resultDiv = document.getElementById("sync-images-result");

        const imageSize = imageSizeSelect.value;

        syncImagesBtn.disabled = true;
        resultDiv.innerHTML = `<div class="alert alert-info">Downloading images quality - (${imageSize})...</div>`;

        try {
            const response = await fetch("/api/sync-images", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ size: imageSize }),
            });

            const data = await response.json();

            if (data.success) {
                const sizeMB = (data.data.total_bytes / (1024 * 1024)).toFixed(
                    2,
                );
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        ${data.message}
                        ${data.data.images_downloaded > 0 ? `<br>Downloaded ${data.data.images_downloaded} image(s) (${sizeMB} MB)` : ""}
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-error">${data.message || data.error}</div>
                `;
            }
        } catch (error) {
            resultDiv.innerHTML = `
                <div class="alert alert-error">Image sync failed: ${error.message}</div>
            `;
        } finally {
            syncImagesBtn.disabled = false;
        }
    }

    async function login() {
        const loginBtn = document.getElementById("login-btn");
        const regionSelect = document.getElementById("login-region");
        const resultDiv = document.getElementById("account-result");

        const region = regionSelect.value;

        loginBtn.disabled = true;
        resultDiv.innerHTML =
            '<div class="alert alert-info">Opening browser for login... Please complete the login in the browser window that opens.</div>';

        try {
            const response = await fetch("/api/auth/login", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ region: region }),
            });

            const data = await response.json();

            if (data.success) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">${data.message}</div>
                `;
                // Reload account status panel
                setTimeout(() => {
                    loadAccountStatusPanel();
                    resultDiv.innerHTML = "";
                }, 2000);
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-error">${data.message || data.error}</div>
                `;
            }
        } catch (error) {
            resultDiv.innerHTML = `
                <div class="alert alert-error">Login failed: ${error.message}</div>
            `;
        } finally {
            loginBtn.disabled = false;
        }
    }

    async function logout() {
        if (
            !confirm(
                "Are you sure you want to logout? This will clear your stored session.",
            )
        ) {
            return;
        }

        const logoutBtn = document.getElementById("logout-btn");
        const resultDiv = document.getElementById("account-result");

        logoutBtn.disabled = true;
        resultDiv.innerHTML =
            '<div class="alert alert-info">Logging out...</div>';

        try {
            const response = await fetch("/api/auth/logout", {
                method: "POST",
            });

            const data = await response.json();

            if (data.success) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">${data.message}</div>
                `;
                // Reload account status panel
                setTimeout(() => {
                    loadAccountStatusPanel();
                }, 1000);
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-error">${data.message || data.error}</div>
                `;
            }
        } catch (error) {
            resultDiv.innerHTML = `
                <div class="alert alert-error">Logout failed: ${error.message}</div>
            `;
        } finally {
            logoutBtn.disabled = false;
        }
    }
</script>

{% endblock %}
